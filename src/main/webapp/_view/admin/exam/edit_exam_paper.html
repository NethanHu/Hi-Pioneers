<!-- 主界面 -->
<div class="main">
<!-- 主体内容 -->
    <form id="exam-form" action="/admin/exam/save" method="POST"
          onsubmit="return false;">
    <div id="table-box" class="table-box">
        <input type="hidden" id="paper_content" value="#(page.getList().size())">

        <input type="text" name="exam.examName" value="#(exam.exam_name ??)"class="form-control"placeholder="考试名称">
        <input type="hidden" name="paper_id" value=#(paper.id)>
        <input type="text" name="exam.startTime" value="#(exam.start_time ??)"class="form-control"placeholder="开考时间">
        <input type="text" name="exam.lastTime" value="#(exam.last_time ??)"class="form-control"placeholder="考试时间">
        <input type="text" name="exam.courseName" value="#(exam.course_name ??)"class="form-control"placeholder="考试科目">
        <div class="form-group">
            ### escape 指令用于解决 ckeditor 无法显示处于 pre 内的 html 源码的问题
            <textarea id="editor1" name="exam.examDescription">#escape(exam.exam_description ??)</textarea>
        </div>

        <table class="table table-hover" >
            <thead>
            <tr>
                <th>序号</th>
                <th>问题</th>
                <th>类型</th>
                <th>难度</th>
                <th class="operation">分值</th>
            </tr>
            </thead>

            <tbody>

            #for (x : page.getList())
            <tr>
                #if("一般选择题".equals(x.type))
                <td id="choice_index_#(page.getList().indexOf(x) + 1)"></td>
                <td><div style="height: 21px; overflow: hidden; text-overflow: ellipsis">#(x.question)</div></td>
                <td>#(x.type)</td>
                <td>#(x.level)</td>
                <td class="operation">
                    <input type="text" id="choice_score_#(page.getList().indexOf(x) + 1)">
                </td>
                #end
            </tr>
            #end

            #for (x : page.getList())
            <tr>
                #if("填空题".equals(x.type))
                <td id="blank_index_#(page.getList().indexOf(x) + 1)"></td>
                <td><div style="height: 21px; overflow: hidden; text-overflow: ellipsis">#(x.question)</div></td>
                <td>#(x.type)</td>
                <td>#(x.level)</td>
                <td class="operation">
                    <input type="text" id="blank_score_#(page.getList().indexOf(x) + 1)">
                </td>
                #end
            </tr>
            #end

            #for (x : page.getList())
            <tr>
                #if("简答题".equals(x.type))
                <td id="answer_index_#(page.getList().indexOf(x) + 1)"></td>
                <td><div style="height: 21px; overflow: hidden; text-overflow: ellipsis">#(x.question)</div></td>
                <td>#(x.type)</td>
                <td>#(x.level)</td>
                <td class="operation">
                    <input type="text" id="answer_score_#(page.getList().indexOf(x) + 1)">
                </td>
                #end
            </tr>
            #end

            </tbody>
        </table>
        <input type="hidden" name="exam.questionScores" id="final_score">
        <div class="form-group text-center">
            <button id="exam_btn" class="btn btn-success btn-sm pl-2 pr-3">
                <i class="fa fa-check mr-1"></i>#(isAdd ? '创建' : '更析')
            </button>
        </div>
    </div>
        </form>
    ### 将 keyword 放入 append，促使分页链接中追加该参数用于搜索
    #set(append = keyword ? '&keyword=' + keyword : '')
    #@adminPaginate(page, "/admin/paper/search?pn=")
</div>

<!-- 弹出层 button -->
<div class="layui-layer-btn" style="padding: 10px 25px 20px 0;">

</div>

<div id="create_paper" class="panel">

</div>

<script src="/assets/js/paper-kit.js"></script>
<script src="/assets/lib/ckeditor/ckeditor.js"></script>

<!-- 弹出层 js 脚本 -->
<script>
    $(function() {
        setIndex();
        // 初始化 ckeditor
        CKEDITOR.replace('editor1', {height: '350px'});

        // 设置第一个 input 为输入焦点
        $("#exam-form input[type='text']:first").focus();

        // 绑定提交按钮事件
        $("#exam_btn").on("click", setExam);

        // 绑定 esc 键关键弹出层
        kit.bindEscKeydown();
    });
    var question_index = 1;
    var question_list_length = parseInt(document.getElementById('paper_content').value);
    var score='';
    function setExam() {
        for (let i = 1; i <=question_list_length ; i++) {
            let choice_score = document.getElementById("choice_score_"+i);
            let blank_score = document.getElementById("blank_score_"+i);
            let answer_score = document.getElementById("answer_score_"+i);
            let final_score = document.getElementById("final_score");

            if (choice_score!=null){
                score=score+"~~~"+choice_score.value;
            }
            else if (blank_score!=null){
                score=score+"~~~"+blank_score.value;
            }
            else if (answer_score!=null){
                score=score+"~~~"+answer_score.value;
            }
            final_score.setAttribute('value',score);
        }
        // 使用 jquery form 插件，接管表单提交事件，并将表单提交自动转化成 ajax 提交
        $("#exam-form").ajaxSubmit({
            dataType: 'json', type: 'POST',
            beforeSerialize: function($form, options) {
                // 将 ckeditor 中的数据同步到 textarea，否则数据无法提交到服务端
                for (instance in CKEDITOR.instances) {
                    CKEDITOR.instances[instance].updateElement();
                }
                kit.loading({msg: '正在保存, 请稍候 .....'});
            },
            success: function(ret) {
                kit.closeLoading();		// 关闭 loading 层
                kit.msg(ret);

                if (ret.state == "ok") {
                    setTimeout(function() {
                        location.href = "/admin/exam?pn=#(pn ? pn : 1)";
                    }, 2100);
                }
            }
        });
    }
    function setIndex() {
        for (let i = 1; i <=question_list_length ; i++) {
            let option_content = document.getElementById('choice_index_' + i);
            if (option_content == null) {
                continue;
            }
            option_content.innerHTML = question_index;
            question_index++;
        }
        for (let i = 1; i <=question_list_length ; i++) {
            let option_content = document.getElementById('blank_index_' + i);
            if (option_content == null) {
                continue;
            }
            option_content.innerText = question_index;
            question_index++;
        }
        for (let i = 1; i <=question_list_length ; i++) {
            let option_content = document.getElementById('answer_index_' + i);
            if (option_content == null) {
                continue;
            }
            option_content.innerText = question_index;
            question_index++;
        }
    }




</script>